# WeDAP 服务目录

## 服务拓扑

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                 接入层 (Clients)                                 │
│           银行APP | Web3 H5 | 银行柜面 | 运营后台 | Web3钱包系统                 │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            wedap-gateway (网关层)                                │
│  ┌─────────────────────────────┐    ┌─────────────────────────────┐            │
│  │       API Gateway           │    │       APP Gateway           │            │
│  │   (鉴权/限流/路由/协议转换)   │    │  (H5入口/登录态/防篡改)      │            │
│  │        Port: 8080           │    │        Port: 8081           │            │
│  └─────────────────────────────┘    └─────────────────────────────┘            │
└─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                ┌───────────────────────┼───────────────────────┐
                │                       │                       │
                ▼                       ▼                       ▼
┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
│   wedap-adapter      │  │   wedap-web2-core    │  │   wedap-counter      │
│     (适配层)          │  │    (核心业务层)       │  │     (柜面层)         │
│    Port: 8082        │  │    Port: 8083        │  │    Port: 8084        │
├──────────────────────┤  ├──────────────────────┤  ├──────────────────────┤
│ ▪ WEB2.0 适配器       │  │ ▪ 小总账             │  │ ▪ 工单审批           │
│ ▪ WEB3.0 Connector   │  │ ▪ 支付管理           │  │ ▪ 预约工单           │
│ ▪ WEB2.0 Connector   │  │ ▪ 客户钱包地址管理    │  │ ▪ 客户信息管理       │
│ ▪ 内部路由器          │  │ ▪ 资本管理           │  │ ▪ 小总账&资本查询    │
│                      │  │ ▪ 监管报送 / AML     │  │ ▪ 监管&反洗钱查询    │
│                      │  │ ▪ 参数配置 / 对账     │  │ ▪ 参数管理           │
└──────────────────────┘  └──────────────────────┘  └──────────────────────┘
        │                         │                         │
        └─────────────────────────┼─────────────────────────┘
                                  │
          ┌───────────────────────┼───────────────────────┐
          ▼                       ▼                       ▼
┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐
│   银行核心系统    │  │   外部Web3服务   │  │   支付通道        │
│ 大总账/Oracle/SAP│  │ BitGo/Circle    │  │ SWIFT/SEPA      │
└──────────────────┘  └──────────────────┘  └──────────────────┘
```

---

## 服务详情

### 核心服务清单

| 服务 | 仓库 | 职责 | 端口 | 所属模块 |
|------|------|------|------|----------|
| API Gateway | wedap-gateway | Web2/Web3双向访问、鉴权限流、协议转换 | 8080 | 网关层 |
| APP Gateway | wedap-gateway | H5统一入口、登录态打通、防篡改防重放 | 8081 | 网关层 |
| Adapter Service | wedap-adapter | 标准接口适配、Connector路由 | 8082 | 适配层 |
| Core Service | wedap-web2-core | 会计核算、支付清算、合规报送 | 8083 | 业务层 |
| Counter Service | wedap-counter | 工单审批、客户管理、数据查询 | 8084 | 柜面层 |
| Counter Web | wedap-counter | 银行柜面前端界面 | 3000 | 柜面层 |

### 模块服务明细

#### wedap-gateway 模块

| 子服务 | 功能 | 核心能力 |
|--------|------|----------|
| API Gateway | Web2/Web3 双向访问 | 统一API入口、JWT鉴权、限流熔断、路由转发、报文协议转换 |
| APP Gateway | H5 统一流量入口 | PKCE登录态打通、Token认证、防篡改、防重放、灰度发布 |

#### wedap-adapter 模块

| 子服务 | 功能 | 核心能力 |
|--------|------|----------|
| WEB2.0 适配器 | 标准接口封装 | 对Web3屏蔽银行差异、标准服务路由配置 |
| 内部路由器 | Connector选择 | 根据bankId和配置动态选择Connector |
| WEB3.0 Connector | Web3系统对接 | 标准透传、差异化定制能力 |
| WEB2.0 Connector | 银行系统对接 | 插件化架构、多银行多系统适配 |

**WEB2.0 Connector 插件清单：**

| Connector | 对接系统 | 功能说明 |
|-----------|----------|----------|
| 核心 Connector | 银行核心系统 | 账户查询、转账、余额等基础操作 |
| Oracle 总账 Connector | Oracle ERP | 总账凭证、会计分录对接 |
| SAP 总账 Connector | SAP ERP | 总账凭证、会计分录对接 |
| SWIFT Connector | SWIFT网络 | 跨境支付报文处理 |
| SEPA Connector | SEPA网络 | 欧元区支付处理 |
| AML Connector | 反洗钱系统 | AML数据报送对接 |

#### wedap-web2-core 模块

| 子服务 | 功能 | 核心能力 |
|--------|------|----------|
| 小总账 | 会计流水加工 | 数据标准化、客户信息映射、多币种换汇、格式转换 |
| 支付管理 | 支付路由 | 渠道差异屏蔽、路由策略（费用/时效）、多通道选择 |
| 客户钱包地址管理 | 地址映射 | 客户-钱包映射、本人交易合法性校验 |
| 资本管理 | RWA/减值 | 原始交易数据采集、RWA/减值数据加工 |
| 监管报送 | 监管合规 | 数据标准化、格式转换、监管系统对接 |
| AML | 反洗钱 | AML规则筛查、数据加工、反洗钱系统对接 |
| 参数配置 | 基础配置 | 业务策略、渠道配置、租户管理、账簿管理 |
| 流水对账 | 状态同步 | 交易流水比对、状态一致性保证 |
| 对账文件 | 文件生成 | 对账文件生成，供银行/Web3使用 |

#### wedap-counter 模块

| 子服务 | 功能 | 核心能力 |
|--------|------|----------|
| 工单审批 | 异步交易处理 | 通用工单、开户/转账/手续费/交易冲正 |
| 预约工单 | 大额预约 | 预约审批、流动性准备、到期处理 |
| 客户信息管理 | KYC管理 | 批量上传、覆盖更新、KYC查询 |
| 小总账&资本管理 | 数据查询 | 会计流水查询、资本数据下载 |
| 监管&反洗钱 | 合规查询 | 监管数据查询、反洗钱数据下载 |
| 参数管理 | 运营配置 | 大额交易限额等业务参数配置 |

---

## 依赖关系

### 服务依赖矩阵

| 服务 | 上游依赖 | 下游消费者 |
|------|----------|-----------|
| wedap-gateway (API) | - | wedap-adapter, wedap-web2-core, 银行后台 |
| wedap-gateway (APP) | - | wedap-adapter, Web3 H5 |
| wedap-adapter | wedap-gateway | wedap-counter, 外部Connector |
| wedap-web2-core | wedap-gateway | 银行核心系统, 大总账系统 |
| wedap-counter | wedap-adapter | 银行柜面用户 |

### 外部系统依赖

| 外部系统 | 调用方 | 通信方式 | 功能 |
|----------|--------|----------|------|
| BitGo | wedap-adapter | REST API | 托管钱包创建、数字资产兑换 |
| Circle | wedap-adapter | REST API | 稳定币铸造/赎回 |
| 银行核心 | wedap-web2-core | 内部API | 账户操作、转账 |
| Oracle/SAP 总账 | wedap-web2-core | Connector | 会计凭证对接 |
| SWIFT | wedap-adapter | 报文 | 跨境支付 |
| SEPA | wedap-adapter | 报文 | 欧元区支付 |
| 银行AML系统 | wedap-web2-core | 内部API | 反洗钱数据报送 |
| 监管系统 | wedap-web2-core | 文件/API | 监管数据报送 |

### 依赖关系图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                               服务依赖关系                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│   ┌──────────────────────────────────────────────────────────┐                  │
│   │                   wedap-gateway                           │                  │
│   │              (所有请求的统一入口)                          │                  │
│   └──────────────────────────┬───────────────────────────────┘                  │
│                              │                                                   │
│          ┌───────────────────┼───────────────────┐                              │
│          │                   │                   │                              │
│          ▼                   ▼                   ▼                              │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                        │
│   │   adapter   │    │ web2-core   │    │  counter    │                        │
│   │ (协议适配)  │    │ (核心业务)   │    │  (柜面)     │                        │
│   └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                        │
│          │                  │                  │                                │
│          │    ┌─────────────┘                  │                                │
│          │    │                                │                                │
│          ▼    ▼                                │                                │
│   ┌─────────────────────────────┐              │                                │
│   │      Connector 层            │◄─────────────┘                                │
│   │ Web3 | Web2 | 支付通道       │                                               │
│   └──────────────┬──────────────┘                                               │
│                  │                                                               │
│    ┌─────────────┼─────────────┐                                                │
│    ▼             ▼             ▼                                                │
│ ┌──────┐    ┌──────┐    ┌──────┐                                               │
│ │BitGo │    │Circle│    │SWIFT │                                               │
│ │钱包  │    │稳定币 │    │SEPA  │                                               │
│ └──────┘    └──────┘    └──────┘                                               │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 通信协议

### 同步通信 (REST/HTTP)

| 调用方 | 被调用方 | 协议 | 场景 |
|--------|----------|------|------|
| 银行APP/H5 | wedap-gateway | HTTPS | 所有业务请求入口 |
| wedap-gateway | wedap-adapter | HTTP | 协议适配、路由转发 |
| wedap-gateway | wedap-web2-core | HTTP | 业务逻辑处理 |
| wedap-adapter | Connector | HTTP/报文 | 外部系统调用 |
| Connector | wedap-counter | HTTP | 工单创建、KYC查询 |
| wedap-gateway | 银行后台 | HTTPS | 账户查询、转账 |

### 异步通信 (工单/回调)

| 场景 | 发起方 | 处理方 | 回调链路 |
|------|--------|--------|----------|
| 稳定币申购 | Web3 Wallet | wedap-counter | counter → Connector → Wallet |
| 提现处理 | Web3 Wallet | wedap-counter | counter → Connector → Wallet |
| 大额预约 | 客户 | 银行运营 | counter → Web3通知 |

---

## 认证机制

### APP登录态打通 (PKCE + JWT)

| 步骤 | 参与方 | 操作 |
|------|--------|------|
| 1 | 银行APP | 生成 Verifier，计算 Challenge = SHA256(Verifier) |
| 2 | 银行APP → 银行后台 | 申请JWT，携带 code_challenge |
| 3 | 银行后台 | 签发JWT（含sub, cnf, exp, jti） |
| 4 | 银行APP → Web3 H5 | JSBridge传递 {token, verifier} |
| 5 | Web3 H5 → APP Gateway | POST /login_by_token |
| 6 | APP Gateway | 验签 → 验时效 → 防重放 → PKCE校验 |
| 7 | APP Gateway → H5 | 返回 Session/AccessToken |

### 安全校验清单

| 校验项 | 说明 | 失败处理 |
|--------|------|----------|
| JWT验签 | 使用银行公钥验证签名 | 401: Token无效 |
| Token时效 | 检查是否在30秒有效期内 | 401: Token过期 |
| JTI防重放 | Redis检查JTI是否已使用 | 401: Token已失效/重放攻击 |
| PKCE校验 | SHA256(verifier) == cnf | 401: 非法请求 |

---

## 健康检查

### 统一健康检查端点

| 检查类型 | 端点 | 说明 |
|----------|------|------|
| 存活检查 | `GET /actuator/health/liveness` | 服务进程是否存活 |
| 就绪检查 | `GET /actuator/health/readiness` | 服务是否可接收流量 |
| 详细状态 | `GET /actuator/health` | 完整健康状态（含依赖） |

### 服务健康检查矩阵

| 服务 | 端口 | 存活检查 | 就绪检查 | 依赖检查项 |
|------|------|----------|----------|------------|
| API Gateway | 8080 | /health/liveness | /health/readiness | Redis, 下游服务 |
| APP Gateway | 8081 | /health/liveness | /health/readiness | Redis, 银行后台 |
| Adapter | 8082 | /health/liveness | /health/readiness | DB, Connector |
| Web2-Core | 8083 | /health/liveness | /health/readiness | DB, 银行系统 |
| Counter | 8084 | /health/liveness | /health/readiness | DB |

---

## 服务配置

### 关键配置项

| 服务 | 配置项 | 说明 |
|------|--------|------|
| API Gateway | 限流阈值、路由规则、超时时间 | 流量控制 |
| APP Gateway | JWT公钥、Token时效、JTI过期时间 | 认证安全 |
| Adapter | bankId路由映射、Connector列表 | 适配路由 |
| Web2-Core | 支付通道配置、汇率配置、报送周期 | 业务参数 |
| Counter | 大额限额、审批流程、工单超时 | 运营参数 |

### 多租户配置

| 配置维度 | 说明 | 存储位置 |
|----------|------|----------|
| bankId | 银行标识，路由选择依据 | 配置中心 |
| Connector映射 | 各银行对应的Connector | wedap-adapter |
| 业务参数 | 各银行独立的限额、策略等 | wedap-web2-core |
| 租户信息 | 租户基本信息、接入配置 | wedap-counter |

---

## 监控告警

### 关键监控指标

| 指标类别 | 指标名 | 告警阈值 | 说明 |
|----------|--------|----------|------|
| 可用性 | 服务存活率 | < 99.9% | 服务健康状态 |
| 延迟 | P99响应时间 | > 3s | 接口响应性能 |
| 错误率 | 5xx错误率 | > 1% | 服务端错误 |
| 流量 | QPS | 根据容量 | 请求量 |
| 安全 | 认证失败率 | > 5% | 异常登录检测 |
| 业务 | 工单积压数 | > 100 | 工单处理效率 |

### 核心业务告警

| 告警场景 | 触发条件 | 处理建议 |
|----------|----------|----------|
| 登录态异常 | PKCE校验失败率 > 1% | 检查银行公钥、时钟同步 |
| 工单堆积 | 待处理工单 > 阈值 | 增加柜员、检查系统 |
| 对账差异 | 差异笔数 > 0 | 人工介入处理 |
| Connector超时 | 外部调用超时率 > 5% | 检查外部系统状态 |

---

## 部署信息

### 服务部署矩阵

| 服务 | 实例数 | 部署方式 | 资源配置 |
|------|--------|----------|----------|
| wedap-gateway | >= 2 | 集群部署 | 高可用、负载均衡 |
| wedap-adapter | >= 2 | 集群部署 | 按流量扩展 |
| wedap-web2-core | >= 2 | 集群部署 | 按业务量扩展 |
| wedap-counter | >= 2 | 集群部署 | 前后端分离 |

### 基础设施依赖

| 组件 | 用途 | 高可用方案 |
|------|------|------------|
| 负载均衡 | 流量分发 | 主备/多活 |
| Redis | Session、JTI防重放、限流 | 集群/哨兵 |
| 数据库 | 业务数据存储 | 主从复制 |
| 配置中心 | 配置管理 | 集群部署 |

---

## 快速导航

- [仓库地图](./repomap-WeDap.md) - 仓库清单与依赖关系
- [数据流图](./data-flow.md) - 核心数据流转
- [API文档模板](../standards/api-document-template.md) - 接口文档规范

## 相关链接

- [架构知识入口](../ARCHITECTURE.md) - WeDAP技术架构
- [业务知识入口](../BUSINESS.md) - WeDAP业务领域
- [代码仓库](../代码仓库.md) - 系统仓库清单与交互时序
