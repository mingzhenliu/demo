- # WeDAP 架构知识入口

  ## 架构定位

  WeDAP 采用**非侵入式适配层架构**，作为 Web2 银行与 Web3 系统之间的标准化桥梁。核心设计理念是**双向屏蔽**：对传统银行屏蔽 Web3 底层复杂性，对 Web3 屏蔽各银行差异。

  ## 系统架构

  ```
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                                 客户端层                                         │
  │           银行APP | Web3 H5 | 银行柜面 | 运营后台                                 │
  └─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                            wedap-gateway (网关层)                                │
  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐              │
  │  │       API Gateway           │  │       APP Gateway           │              │
  │  │  (Web2/Web3 双向访问)        │  │  (H5统一入口/登录态打通)     │              │
  │  │  鉴权 | 限流 | 路由 | 协议转换 │  │  防篡改 | 防重放 | 灰度发布  │              │
  │  └─────────────────────────────┘  └─────────────────────────────┘              │
  └─────────────────────────────────────────────────────────────────────────────────┘
                                        │
                ┌───────────────────────┼───────────────────────┐
                ▼                       ▼                       ▼
  ┌──────────────────────┐  ┌──────────────────────┐  ┌──────────────────────┐
  │   wedap-adapter      │  │   wedap-web2-core    │  │   wedap-counter      │
  │     (适配器层)        │  │    (Web2核心层)       │  │     (柜面层)         │
  ├──────────────────────┤  ├──────────────────────┤  ├──────────────────────┤
  │ WEB2.0 适配器        │  │ 小总账               │  │ 工单审批             │
  │ WEB3.0 Connector     │  │ 支付管理             │  │ 预约工单             │
  │ WEB2.0 Connector     │  │ 客户钱包地址管理     │  │ 客户信息管理         │
  │ 内部路由器           │  │ 资本管理             │  │ 小总账&资本查询      │
  │                      │  │ 监管报送 / AML       │  │ 监管&反洗钱查询      │
  │                      │  │ 参数配置 / 对账      │  │ 参数管理             │
  └──────────────────────┘  └──────────────────────┘  └──────────────────────┘
                │                       │                       │
                └───────────────────────┼───────────────────────┘
                                        │
            ┌───────────────────────────┼───────────────────────────┐
            ▼                           ▼                           ▼
  ┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐
  │   Web3 系统       │      │   银行核心系统    │      │   外部服务        │
  │  钱包 | 链上合约  │      │ 大总账 | 核心    │      │ BitGo | Circle   │
  │                  │      │ Oracle | SAP     │      │ SWIFT | SEPA     │
  └──────────────────┘      └──────────────────┘      └──────────────────┘
  ```

  ---

  ## 服务全景

  | 系统/仓库           | 子系统号 | 职责         | 核心能力                                |
  | ------------------- | -------- | ------------ | --------------------------------------- |
  | **wedap-gateway**   | 6601     | 统一网关     | API路由、鉴权限流、协议转换、登录态打通 |
  | **WEDAP-AUTH**      | 6602     | 柜面用户权限  | 柜面用户权限管理                    |
  | **WEDAP-FLOW**      | 6603     | 柜面审批流    | 柜面审批流                         |
  | **wedap-adapter**   | 6604     | 协议适配     | 标准接口、Connector插件、双向屏蔽       |
  | **wedap-web2-core** | 6606     | Web2核心业务 | 会计核算、支付清算、合规报送、对账      |
  | **wedap-counter**   | 6605     | 银行柜面     | 工单审批、客户管理、数据查询、参数配置  |

  ---

  ## 模块详细清单

  ### wedap-gateway 模块
  
  | 模块        | 职责              | 核心能力                                        |
  | ----------- | ----------------- | ----------------------------------------------- |
  | API Gateway | Web2/Web3双向访问 | 统一API入口、鉴权、限流、路由、报文协议转换     |
  | APP Gateway | H5统一流量入口    | 登录态打通、防篡改、防重放、灰度发布、Token认证 |

  ### wedap-adapter 模块
  
  | 模块             | 职责          | 核心能力                          |
  | ---------------- | ------------- | --------------------------------- |
  | WEB2.0 适配器    | 标准接口封装  | 对Web3屏蔽银行差异、标准服务路由  |
  | 内部路由器       | Connector选择 | 根据bankId和配置选择对应Connector |
  | WEB3.0 Connector | Web3对接      | 标准透传、差异化定制能力          |
  | WEB2.0 Connector | 银行对接      | 插件化架构、多银行多系统适配      |

  **WEB2.0 Connector 插件清单：**
  
  - 核心 Connector（银行核心系统）
  - Oracle 总账 Connector
  - SAP 总账 Connector
  - SWIFT Connector
  - SEPA Connector
  - AML Connector

  ### wedap-web2-core 模块
  
  | 模块             | 职责         | 核心能力                                   |
  | ---------------- | ------------ | ------------------------------------------ |
  | 小总账           | 会计流水加工 | 数据标准化、客户映射、多币种换汇、格式转换 |
  | 支付管理         | 支付路由     | 渠道差异屏蔽、路由策略、多通道选择         |
  | 客户钱包地址管理 | 地址映射     | 客户-钱包映射、本人交易校验                |
  | 资本管理         | RWA/减值     | 原始数据采集、RWA/减值数据加工             |
  | 监管报送         | 监管合规     | 数据标准化、格式转换、监管系统对接         |
  | AML              | 反洗钱       | AML规则筛查、数据加工、反洗钱系统对接      |
  | 参数配置         | 基础配置     | 业务策略、渠道配置、租户管理、账簿管理     |
  | 流水对账         | 状态同步     | 交易流水比对、状态一致性保证               |
  | 对账文件         | 文件生成     | 对账文件生成、供银行/Web3使用              |

  ### wedap-counter 模块
  
  | 模块            | 职责         | 核心能力                        |
  | --------------- | ------------ | ------------------------------- |
  | 工单审批        | 异步交易处理 | 通用工单、开户/转账/手续费/冲正 |
  | 预约工单        | 大额预约     | 预约审批、流动性准备            |
  | 客户信息管理    | KYC管理      | 批量上传、增量更新、信息查询    |
  | 小总账&资本管理 | 数据查询     | 会计流水查询、资本数据下载      |
  | 监管&反洗钱     | 合规查询     | 监管数据查询、反洗钱数据下载    |
  | 参数管理        | 运营配置     | 限额配置、业务参数              |

  ---

  ## 核心依赖关系
  
  ```
                        ┌─────────────────────────────────────────────┐
                        │             wedap-gateway                    │
                        │         (统一流量入口)                        │
                        └─────────────────┬───────────────────────────┘
                                          │
                      ┌───────────────────┼───────────────────┐
                      │                   │                   │
                      ▼                   ▼                   ▼
            ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
            │  wedap-adapter  │ │ wedap-web2-core │ │  wedap-counter  │
            │   (协议适配)    │ │   (核心业务)    │ │    (柜面)       │
            └────────┬────────┘ └────────┬────────┘ └────────┬────────┘
                     │                   │                   │
                     │                   │    ┌──────────────┘
                     │                   │    │
                     ▼                   ▼    ▼
            ┌─────────────────────────────────────────────────────────┐
            │                    Connector 层                          │
            │  ┌───────────┐  ┌───────────┐  ┌───────────┐            │
            │  │  Web3.0   │  │  Web2.0   │  │ 支付通道  │            │
            │  │ Connector │  │ Connector │  │ Connector │            │
            │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘            │
            └────────┼──────────────┼──────────────┼──────────────────┘
                     │              │              │
          ┌──────────┘              │              └──────────┐
          ▼                         ▼                         ▼
  ┌───────────────┐      ┌───────────────┐      ┌───────────────┐
  │   Web3 系统    │      │  银行核心系统  │      │   外部服务    │
  │ Wallet/BitGo  │      │ 大总账/Oracle │      │ Circle/SWIFT │
  └───────────────┘      └───────────────┘      └───────────────┘
  ```

  **依赖规则：**
  
  1. `wedap-gateway` 是所有请求的统一入口
  2. `wedap-gateway` 依赖 `wedap-adapter` 和 `wedap-web2-core`
  3. `wedap-adapter` 通过 Connector 对接外部系统
  4. `wedap-counter` 提供柜面操作能力，可被 Connector 调用

  ---

  ## 分层架构
  
  ```
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                              接入层 (Access Layer)                               │
  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
  │  │  银行APP    │  │  Web3 H5   │  │  银行柜面   │  │  运营后台   │            │
  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              网关层 (Gateway Layer)                              │
  │                         wedap-gateway                                           │
  │                   API Gateway | APP Gateway                                     │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              适配层 (Adapter Layer)                              │
  │                         wedap-adapter                                           │
  │              WEB2.0适配器 | 内部路由器 | Connector                               │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              业务层 (Business Layer)                             │
  │  ┌────────────────────────────────┐  ┌────────────────────────────────┐        │
  │  │       wedap-web2-core          │  │       wedap-counter            │        │
  │  │  会计核算 | 支付清算 | 合规报送 │  │  工单审批 | 客户管理 | 参数配置 │        │
  │  └────────────────────────────────┘  └────────────────────────────────┘        │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              集成层 (Integration Layer)                          │
  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
  │  │  银行核心   │  │  大总账     │  │  监管系统   │  │  AML系统    │            │
  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐            │
  │  │   BitGo    │  │   Circle    │  │   SWIFT     │  │   SEPA      │            │
  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘            │
  └─────────────────────────────────────────────────────────────────────────────────┘
  ```

  ---

  ## 通信模式

  ### 同步通信 (REST/HTTP)
  
  | 调用方        | 被调用方        | 场景               |
  | ------------- | --------------- | ------------------ |
  | 银行APP/H5    | wedap-gateway   | 所有业务请求入口   |
  | wedap-gateway | wedap-adapter   | 协议适配、路由转发 |
  | wedap-gateway | wedap-web2-core | 业务逻辑处理       |
  | wedap-adapter | Connector       | 外部系统调用       |
  | Connector     | wedap-counter   | 工单创建、KYC查询  |
  | wedap-gateway | 银行后台        | 账户查询、转账     |

  ### 异步通信 (工单/回调)
  
  | 场景       | 发起方      | 处理方   | 回调方                             |
  | ---------- | ----------- | -------- | ---------------------------------- |
  | 稳定币申购 | Web3 Wallet | 银行柜面 | wedap-counter → Connector → Wallet |
  | 提现处理   | Web3 Wallet | 银行柜面 | wedap-counter → Connector → Wallet |
  | 大额预约   | 客户        | 银行运营 | wedap-counter → Web3通知           |

  ### 登录态打通 (PKCE + JWT)
  
  ```
  银行APP                      WeDAP-APP Gateway                    Web3 H5
      │                              │                                │
      │  1. 生成 Verifier            │                                │
      │  2. Challenge=SHA256(Verifier)                                │
      │                              │                                │
      │──────POST /get_handoff_token──────▶│                          │
      │     {code_challenge}         │                                │
      │                              │                                │
      │◀─────返回 JWT────────────────│                                │
      │                              │                                │
      │──────JSBridge传递────────────────────────────────────────────▶│
      │     {token, verifier}        │                                │
      │                              │                                │
      │                              │◀───POST /login_by_token────────│
      │                              │    {token, verifier}           │
      │                              │                                │
      │                              │  验签 → 验时效 → 防重放 → PKCE校验
      │                              │                                │
      │                              │───────返回 Session─────────────▶│
  ```

  ---

  ## 插件化架构

  ### Connector 插件体系
  
  ```
                      ┌─────────────────────────────────┐
                      │        wedap-adapter            │
                      │      (适配器核心)                │
                      └────────────────┬────────────────┘
                                       │
                      ┌────────────────┼────────────────┐
                      │                │                │
                      ▼                ▼                ▼
            ┌─────────────────┐ ┌────────────────┐ ┌─────────────────┐
            │  内部路由器      │ │ WEB2.0 适配器 │ │ WEB3.0 Connector│
            │ (bankId路由)    │ │ (标准接口)    │ │  (默认透传)      │
            └────────┬────────┘ └───────┬────────┘ └────────┬────────┘
                     │                  │                   │
                     ▼                  ▼                   ▼
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                         WEB2.0 Connector 插件池                                  │
  ├─────────────┬─────────────┬─────────────┬─────────────┬─────────────────────────┤
  │ 核心Connector │ Oracle总账  │ SAP总账     │ SWIFT       │ SEPA       │ AML       │
  │ (银行核心)   │ Connector   │ Connector   │ Connector   │ Connector  │ Connector │
  └─────────────┴─────────────┴─────────────┴─────────────┴────────────┴───────────┘
  ```

  **插件化设计原则：**
  
  1. **标准接口**：所有 Connector 实现统一接口
  2. **按需加载**：银行可选择需要的 Connector 模块
  3. **隔离变化**：新银行接入只需开发新 Connector，不影响其他模块
  4. **路由配置**：通过 bankId 和配置动态选择 Connector

  ---

  ## 数据流

  ### 入金流程数据流
  
  ```
  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
  │ 客户H5  │───▶│ Gateway │───▶│ Wallet  │───▶│ Adapter │───▶│ Counter │
  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
      │              │              │              │              │
      │  充值请求    │  转发请求    │  扣款请求    │  创建工单    │
      │              │              │              │              │
      └──────────────┴──────────────┴──────────────┴──────────────┘
                                                                 │
                             ┌───────────────────────────────────┘
                             ▼
                      ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
                      │  银行柜面   │───▶│   Circle    │───▶│   Wallet    │
                      │  (人工处理) │    │  (资金到账) │    │ (余额更新)  │
                      └─────────────┘    └─────────────┘    └─────────────┘
  ```

  ### 会计数据流
  
  ```
  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
  │  交易发生   │───▶│  小总账     │───▶│  数据标准化 │───▶│  格式转换   │
  │ (Web3/银行) │    │  (数据采集) │    │  (客户映射) │    │  (多币种)   │
  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                                 │
                             ┌───────────────────────────────────┘
                             ▼
               ┌─────────────────────────────────────────────────────────┐
               │                    银行大总账系统                        │
               │         Oracle总账 | SAP总账 | 银行核心                  │
               └─────────────────────────────────────────────────────────┘
  ```

  ---

  ## 安全架构
  
  ```
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                              网关层安全                                          │
  │  JWT认证 | 限流熔断 | 报文加密 | 防篡改 | 防重放                                 │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              认证层安全                                          │
  │  PKCE校验 | Token时效(30s) | JTI唯一性 | 银行公钥验签                           │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              业务层安全                                          │
  │  本人交易校验 | 钱包地址验证 | 大额预约审批 | AML筛查                            │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                              数据层安全                                          │
  │  数据加密存储 | 敏感信息脱敏 | 审计日志 | 对账校验                               │
  └─────────────────────────────────────────────────────────────────────────────────┘
  ```

  ### 认证安全机制
  
  | 机制          | 说明                           | 防护目标       |
  | ------------- | ------------------------------ | -------------- |
  | **JWT验签**   | 使用银行公钥验证签名完整性     | 防止伪造Token  |
  | **Token时效** | 30秒有效期，过期失效           | 防止Token泄露  |
  | **JTI唯一性** | JWT ID全局唯一，60秒内不可重复 | 防止重放攻击   |
  | **PKCE校验**  | SHA256(Verifier) = Challenge   | 防止中间人攻击 |

  ---

  ## 架构决策记录
  
  | ADR     | 标题                | 状态   | 决策要点                               |
  | ------- | ------------------- | ------ | -------------------------------------- |
  | ADR-001 | 非侵入式适配层架构  | 已接受 | 不深度改造银行核心，通过适配层屏蔽差异 |
  | ADR-002 | 插件化Connector设计 | 已接受 | 支持多银行多系统，按需加载             |
  | ADR-003 | 工单异步处理模式    | 已接受 | 异步交易转工单，柜员人工处理           |
  | ADR-004 | PKCE登录态打通      | 已接受 | 安全的跨域登录态传递方案               |
  | ADR-005 | 小总账中间层        | 已接受 | 统一会计数据加工，屏蔽大总账差异       |
  | ADR-006 | 双向路由策略        | 已接受 | API Gateway支持Web2/Web3双向访问       |

  ---

  ## 技术栈（推断）
  
  | 层级   | 技术             | 说明                         |
  | ------ | ---------------- | ---------------------------- |
  | 网关   | API Gateway      | 统一入口、路由、限流、鉴权   |
  | 后端   | Java/Spring Boot | 业务服务开发                 |
  | 缓存   | Redis            | JTI防重放、Session存储、限流 |
  | 数据库 | 关系型数据库     | 业务数据、工单数据、配置数据 |
  | 前端   | H5/Vue/React     | Web3 H5页面、柜面系统        |
  | 安全   | JWT + PKCE       | 认证授权                     |
  | 集成   | REST API         | 银行系统、Web3系统对接       |

  ---

  ## 部署架构（逻辑视图）
  
  ```
  ┌─────────────────────────────────────────────────────────────────────────────────┐
  │                              生产环境                                            │
  ├─────────────────────────────────────────────────────────────────────────────────┤
  │                                                                                  │
  │    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐           │
  │    │  负载均衡器     │    │    WAF防护      │    │   CDN加速       │           │
  │    └────────┬────────┘    └────────┬────────┘    └────────┬────────┘           │
  │             │                      │                      │                     │
  │             └──────────────────────┼──────────────────────┘                     │
  │                                    ▼                                            │
  │    ┌───────────────────────────────────────────────────────────────────────┐   │
  │    │                    wedap-gateway (集群)                                │   │
  │    │                    API Gateway | APP Gateway                           │   │
  │    └───────────────────────────────────────────────────────────────────────┘   │
  │                                    │                                            │
  │         ┌──────────────────────────┼──────────────────────────┐                │
  │         ▼                          ▼                          ▼                │
  │    ┌─────────────┐          ┌─────────────┐          ┌─────────────┐          │
  │    │ adapter集群 │          │ web2-core集群│         │ counter集群 │          │
  │    └─────────────┘          └─────────────┘          └─────────────┘          │
  │                                    │                                            │
  │    ┌───────────────────────────────┼───────────────────────────────────────┐   │
  │    │                         数据层                                         │   │
  │    │    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐          │   │
  │    │    │ 主数据库 │    │ 从数据库 │    │  Redis  │    │  日志   │          │   │
  │    │    └─────────┘    └─────────┘    └─────────┘    └─────────┘          │   │
  │    └───────────────────────────────────────────────────────────────────────┘   │
  │                                                                                  │
  └─────────────────────────────────────────────────────────────────────────────────┘
  ```

  ---

  ## 快速导航
  
  - [业务知识入口](./BUSINESS-WeDap.md) - WeDAP业务领域知识
  - [代码仓库](./代码仓库.md) - 系统仓库清单与交互时序
  - [数据流图](./architecture/data-flow.md) - 数据流转关系

  ## 相关链接
  
  - [Web3金融架构](./ARCHITECTURE.md) - Web3金融服务平台架构
  - [Web3金融业务](./BUSINESS.md) - Web3金融服务平台业务
  - [项目规范](./standards/) - 开发规范与标准