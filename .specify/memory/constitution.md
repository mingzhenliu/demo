<!--
  SYNC IMPACT REPORT
  Version Change: 3.1.0 → 3.2.0 (MINOR - 扩展 Web3 安全规范与业务约束)
  Modified Principles:
    - IV. 安全与合规 → IV. 安全与合规（新增 Web3 安全规范、PKCE 认证、工单审批）
  Added Content:
    - Web3 安全规范（托管钱包、链上交易、地址映射）
    - PKCE 登录态打通规范（Token 时效、JTI 防重放、Challenge 校验）
    - 工单异步处理规范（工单闭环、预约审批、状态同步）
    - Connector 插件化规范（标准接口、按需加载、隔离变化）
    - 小总账会计规范（数据标准化、多币种换汇、总账对接）
  Previous Changes (3.1.0):
    - 扩展为 9 层架构 + 模块设计原则
  Templates Updated:
    - ✅ constitution.md (本次更新)
-->

# 项目章程

> 企业级技术宪法 - 下级项目/仓库不可覆盖的强制约束
>
> 项目定位：WeDAP Web3 适配层平台 - 连接传统银行与 Web3 系统的标准化桥梁

## 核心原则

### I. 测试驱动开发

**强制要求**：所有代码必须遵循测试驱动开发流程，测试优先，实现在后。

- 每个 Controller、Service、Mapper 必须有对应测试类
- 核心业务逻辑测试覆盖率 ≥ 80%，工具类 ≥ 90%
- 必须使用 AAA 模式（Arrange-Act-Assert）
- **禁止**：跳过测试、TODO 标记、注释掉测试代码

**理由**：TDD 确保代码质量和业务逻辑正确性，降低生产环境风险。

### II. 规则至上架构

**规则执行优先级**：L0（企业级）> L1（项目级）> L2（仓库级），必须零偏差执行。

- L0 约束不可被下级覆盖
- 严格按规则定义的目录和包结构创建文件
- 遇到错误必须立即停止、删除错误文件、重新按规则执行
- **默认文档目录**：若无明确指定输出目录，且非 CLAUDE.md、AGENTS.md 等框架配置文档的更新，所有生成的文档默认存放于 `.knowledge/` 目录

**理由**：确保代码库一致性和团队协作效率，避免架构腐化。

### III. 架构与模块设计

**分层架构约束**：项目采用分层架构设计，通过模块化组织代码，支持业务场景的灵活扩展。

```
┌─────────────────────────────────────────────────────────────┐
│                      接入层                                  │  ← 请求接入、协议转换
├─────────────────────────────────────────────────────────────┤
│                    解决方案层                                │  ← 业务解决方案统一入口
├─────────────────────────────────────────────────────────────┤
│                   子解决方案层                               │  ← 细粒度业务处理能力
├─────────────────────────────────────────────────────────────┤
│                   模块构建层                                 │  ← 按业务功能划分的模块构建器
├─────────────────────────────────────────────────────────────┤
│                   数据服务层                                 │  ← 业务数据获取、处理、封装
├─────────────────────────────────────────────────────────────┤
│                   外部服务层                                 │  ← 外部服务调用、模型转换
├─────────────────────────────────────────────────────────────┤
│                   领域模型层                                 │  ← 核心业务对象、DTO 定义
├─────────────────────────────────────────────────────────────┤
│                   基础设施层                                 │  ← 基础组件、框架封装
├─────────────────────────────────────────────────────────────┤
│                   通用模块层                                 │  ← 公共组件、工具类
└─────────────────────────────────────────────────────────────┘
```

**层级职责说明**：

| 层级 | 职责 | 典型组件 |
|------|------|----------|
| 接入层 | 处理请求接入和协议转换 | Controller、Gateway、Filter |
| 解决方案层 | 业务解决方案的统一入口 | Facade、Orchestrator |
| 子解决方案层 | 细粒度的业务处理能力 | SubSolution、Handler |
| 模块构建层 | 按业务功能划分的模块构建器 | Builder、Assembler |
| 数据服务层 | 业务数据的获取、处理和封装 | DataService、Repository |
| 外部服务层 | 调用外部服务并进行模型转换 | Client、Adapter、Converter |
| 领域模型层 | 核心业务对象和数据传输对象 | Entity、DTO、VO |
| 基础设施层 | 基础组件和框架封装 | Cache、MQ、Config |
| 通用模块层 | 公共组件和工具类 | Utils、Constants、Enums |

**层级依赖规则**：

- 上层可依赖下层，**禁止**下层依赖上层
- 同层之间通过接口交互，**禁止**直接依赖实现
- **禁止**：跨层直接调用（如接入层直接访问数据服务层）
- **禁止**：循环依赖（A→B→C→A）

**模块设计原则**：

- **单一职责**：每个模块有且仅有一个明确目的，一个变更理由
- **松耦合**：模块间通过接口交互，降低相互依赖
- **高内聚**：模块内部实现自洽，相关功能聚合在一起
- **关注点分离**：模块边界与业务能力、领域上下文对齐
- **最小依赖**：仅导入必要依赖，减少系统复杂性

**理由**：清晰的分层和模块边界降低系统复杂度，支持业务场景灵活扩展和独立演进。

### IV. 安全与合规

#### 4.1 通用安全红线

**基础安全约束**：

- **禁止**：硬编码密码、API Key、Token、证书
- **禁止**：日志输出敏感信息（密码、身份证、手机号、银行卡）
- **禁止**：MD5/SHA1 加密密码（必须 BCrypt/Argon2）
- **禁止**：SQL 字符串拼接（必须参数化查询）、MyBatis 使用 `${}`
- **禁止**：直接输出用户输入到页面（XSS 防护）

#### 4.2 Web3 安全规范

**托管钱包安全**：

- 私钥必须托管在 HSM/KMS 或第三方托管服务（BitGo）
- **禁止**：私钥存储在应用服务器或数据库
- 钱包创建必须使用企业级托管服务，不得自建密钥管理
- 钱包地址必须与银行客户一一映射，建立强关联

**链上交易安全**：

- 所有链上交易必须经过本人校验（钱包地址属于当前登录客户）
- 大额交易（≥配置阈值）必须启用双因素认证（2FA）或预约审批
- **禁止**：跳过地址归属校验直接执行交易
- 交易签名必须在安全环境（HSM/托管服务）完成

**地址映射与校验**：

- 钱包地址与客户 ID 的映射关系必须持久化存储
- 交易前必须校验：`walletAddress == customerWalletMapping.get(currentCustomerId)`
- **禁止**：仅依赖前端传参，必须后端强制校验

#### 4.3 PKCE 认证安全

**登录态打通规范**：

- Token 有效期必须 ≤ 30 秒，过期立即失效
- JWT ID（JTI）必须全局唯一，60 秒内不可重复使用（Redis 防重放）
- PKCE Challenge 必须通过 SHA256 验证：`SHA256(Verifier) == Challenge`
- JWT 签名必须使用银行公钥验证，**禁止**跳过签名校验

**防重放攻击**：

```java
// ✅ 正确：JTI 防重放
String jti = jwt.getClaim("jti");
String redisKey = "jwt:jti:" + jti;
if (redisTemplate.hasKey(redisKey)) {
    throw new SecurityException("JWT 已被使用，疑似重放攻击");
}
redisTemplate.opsForValue().set(redisKey, "used", 60, TimeUnit.SECONDS);
```

**PKCE 校验**：

```java
// ✅ 正确：PKCE 校验
String codeChallenge = jwt.getClaim("code_challenge");
String codeVerifier = request.getParameter("code_verifier");
String computedChallenge = DigestUtils.sha256Hex(codeVerifier);
if (!computedChallenge.equals(codeChallenge)) {
    throw new SecurityException("PKCE 校验失败");
}
```

#### 4.4 合规要求（个保法/GDPR/等保 2.0）

**授权与审计**：

- 敏感操作必须后端强制校验授权状态，授权记录持久化存证
- 用户注销必须全链路删除（MySQL/Redis/ES/OSS），删除后校验清理结果
- 敏感操作必须双因素认证，遵循最小权限原则
- 数据分级加密：核心（SM4+信封加密）、重要（AES-256）、一般（可逆脱敏）

**KYC 前置规则**：

- 钱包开户前必须完成银行 KYC 验证
- KYC 资料必须提前上传到系统，支持批量导入和增量更新
- Web3 开户时自动查询 KYC 数据，未通过 KYC 禁止开户

**理由**：安全与合规是企业生存底线，违规将面临重大损失。Web3 业务涉及链上资产，安全要求更高。

### V. RESTful API 标准化

**API 设计规范**：

- 资源化路径（`/users` 而非 `/getUsers`），URL 名词复数、全小写、连字符分隔
- 版本号放在路径中（`/api/v1/`）
- 统一响应格式（code/msg/data/timestamp）
- 必须使用 OpenAPI 3 生成 API 文档

**双向 API 适配**：

- wedap-gateway 支持 Web2（银行 APP）和 Web3（H5）双向访问
- 统一报文协议，对 Web3 屏蔽银行差异，对银行屏蔽 Web3 复杂性
- 所有外部接口必须经过网关统一鉴权和限流

**理由**：统一 API 规范降低联调成本，提升可维护性。

### VI. 生产就绪代码完整性

**代码质量标准**：

- 代码必须可编译、可运行、可测试
- **禁止**：TODO 标记、简化实现、占位代码
- 必须包含完整的错误处理、日志记录、参数验证
- 必须遵循 SOLID 原则

**理由**：半成品代码增加技术债务，降低系统稳定性。

### VII. 运维就绪

**可观测性**：

- 所有服务必须暴露健康检查端点（/actuator/health）
- 关键业务流程必须有全链路追踪（TraceId 贯穿）
- 异常必须上报监控系统，**禁止**静默吞掉
- 日志格式必须包含 traceId，**禁止**明文打印敏感数据

**容错韧性**：

- 外部依赖调用必须设置超时时间
- 核心链路必须有降级方案
- **禁止**单点故障（数据库、缓存、MQ 等）
- 链路 ID 必须在服务间传递

**理由**：可观测性和容错能力是生产系统稳定运行的基础。

### VIII. 数据治理

#### 8.1 事务规范

**基础事务约束**：

- **禁止**：在数据库事务中调用外部 HTTP 服务
- 所有写接口必须支持幂等性（可安全重试）
- 并发修改必须有乐观锁或悲观锁保护
- @Transactional 必须指定 rollbackFor = Exception.class

#### 8.2 工单异步处理

**工单闭环规则**：

- 异步交易（入金/出金/开户）必须转工单处理，**禁止**同步阻塞
- 工单必须经过银行柜员人工审批后才能执行
- 工单完成后必须通知 Web3 系统，确保状态一致性
- **禁止**：工单未完成就通知 Web3 成功

**预约审批流程**：

- 大额交易（≥配置阈值）必须提前预约审批
- 预约单需银行运营人员审批，准备流动性资金
- 预约到期后客户确认实际需求，柜员按实际需求操作
- **禁止**：跳过预约流程直接执行大额交易

**工单类型**：

- 通用工单：开户、转账、手续费、交易冲正
- 预约工单：大额提现预约、大额充值预约

#### 8.3 小总账会计规范

**数据加工规则**：

- 所有交易流水必须经过小总账标准化处理后入账
- 客户信息必须映射为银行客户 ID，建立 Web3 地址与银行客户的关联
- 支持多币种自动换汇，汇率必须使用配置中心实时汇率
- 会计流水格式必须符合银行大总账接口规范

**总账对接**：

- 支持 Oracle 总账、SAP 总账、银行核心系统多种对接方式
- 数据转换必须无损，**禁止**丢失原始交易信息
- 表内/表外资产必须独立核算，符合监管要求

#### 8.4 对账与状态同步

**对账规则**：

- 交易状态必须与银行系统和 Web3 系统保持一致
- 定期生成对账文件（日对账/月对账）供各方使用
- 差异需人工介入处理，**禁止**自动忽略差异
- 对账不平必须告警，阻断后续交易

#### 8.5 审计追踪

**审计日志规范**：

- 关键操作必须记录审计日志（who/when/what/where/result）
- 审计日志禁止删除或篡改，保留期限 ≥6 个月
- 登录失败、权限变更、数据导出、工单审批必须记录
- 核心操作（大额转账、钱包创建）必须区块链存证

**理由**：数据一致性和审计追踪是金融系统的生命线，工单异步处理确保业务合规。

### IX. 简洁性原则

**YAGNI 与 KISS**：

- **禁止**引入未使用的依赖和框架
- 设计模式应用必须有明确业务场景支撑
- 避免过度抽象和过早优化
- 配置必须外部化，支持多环境（dev/test/staging/prod）

**理由**：简洁的系统更容易理解、测试和维护。

### X. SpecKit 中文本地化

**本地化要求**：

- `.specify/` 和 `specs/` 目录下的文件必须使用中文
- 模板文件、项目记忆文件必须使用中文
- 代码注释：核心业务逻辑使用中文，技术实现可用英文

**国际化保留**：

- 面向用户的 UI 组件保留 i18n 支持能力
- API 响应消息和错误码描述支持国际化

**理由**：中文本地化降低本地开发团队理解成本，同时保留国际化能力。

### XI. 插件化架构（Connector）

**Connector 设计原则**：

- 所有外部系统对接必须通过 Connector 插件实现
- Connector 必须实现统一标准接口，**禁止**直接在业务代码中硬编码对接逻辑
- 支持按需加载，银行可选择需要的 Connector 模块
- 新银行接入只需开发新 Connector，**禁止**修改适配器核心代码

**Connector 分类**：

- **Web3.0 Connector**：对接 Web3 钱包系统，默认透传
- **Web2.0 Connector**：对接银行核心系统、大总账、支付通道（SWIFT/SEPA）
- **支付 Connector**：对接外部支付服务（Circle、BitGo）

**路由策略**：

- 根据 bankId 和配置动态选择 Connector
- 内部路由器负责 Connector 选择和调用
- **禁止**：业务代码直接依赖具体 Connector 实现

**理由**：插件化设计隔离变化，支持多银行多系统灵活接入，降低系统耦合度。

---

## 治理规则

### 章程管理

- **章程地位**：本章程优先级高于所有其他实践和约定
- **修订流程**：修订需文档化、审批、制定迁移计划
- **版本控制**：MAJOR（原则移除/重定义）、MINOR（新增原则）、PATCH（澄清/修正）

### 合规检查

- 所有 PR 必须验证章程符合性
- 安全相关变更必须安全团队 Review
- 架构变更必须架构委员会审批
- 数据库 Schema 变更必须 DBA Review
- **Web3 交易必须经过安全审计**（地址映射、本人校验、金额限额）

### 质量门禁

- **代码审查**：所有代码必须 Peer Review
- **测试覆盖率**：核心业务 ≥ 80%，工具类 ≥ 90%
- **静态检查**：必须通过 CheckStyle、SonarQube（无 Critical/Blocker）
- **安全扫描**：依赖漏洞扫描（CVSS ≥ 7 阻断）
- **性能基准**：关键接口响应时间 < 200ms（P95）

### 发布流程

- 生产发布必须经过 staging 环境验证
- 发布必须有可执行的回滚方案
- 业务高峰期禁止发布
- 灰度发布：先 1 个 Pod，观察 10 分钟，再扩展
- **Connector 变更必须独立发布**，不影响其他模块

---

**版本**：3.2.0 | **批准日期**：2025-11-27 | **最后修订**：2026-01-28
